<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memo Raccolta Rifiuti con AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .nav-btn:focus, .gemini-btn:focus {
            outline: 2px solid #4ade80; /* Green-400 */
            outline-offset: 2px;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-2xl mx-auto p-4 sm:p-6">
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8 text-center">
            <!-- Header Section -->
            <div class="flex justify-center mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><path d="M8 2v4"></path><path d="M16 2v4"></path><path d="M3.5 9.09h17"></path><path d="M21 8.5V20a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8.5"></path><path d="M12 18h.01"></path><path d="M12 14h.01"></path><path d="M16 18h.01"></path><path d="M16 14h.01"></path><path d="M8 18h.01"></path><path d="M8 14h.01"></path></svg>
            </div>
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4" id="current-day-display"></h1>
            
            <!-- Schedule Display -->
            <div class="bg-green-50 rounded-lg p-4 sm:p-6 mt-4 border border-green-200 min-h-[100px] flex items-center justify-center">
                <p class="text-lg sm:text-xl text-gray-700" id="collection-schedule"></p>
            </div>

            <!-- Navigation Buttons -->
            <div class="flex items-center justify-between mt-8">
                <button id="prev-day" class="nav-btn bg-gray-200 text-gray-700 hover:bg-gray-300 font-bold p-3 rounded-full transition-transform transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                </button>
                <button id="go-to-today" class="nav-btn bg-green-500 text-white hover:bg-green-600 font-semibold py-2 px-6 rounded-lg transition-transform transform hover:scale-105">
                    Oggi
                </button>
                <button id="next-day" class="nav-btn bg-gray-200 text-gray-700 hover:bg-gray-300 font-bold p-3 rounded-full transition-transform transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
                </button>
            </div>
            
            <!-- Gemini API Section -->
            <div class="mt-10 pt-8 border-t border-gray-200">
                <h2 class="text-xl font-bold text-gray-700 mb-2">Hai un dubbio? Chiedi all'IA!</h2>
                <p class="text-gray-500 mb-4">Non sai dove buttare qualcosa? Scrivilo qui sotto.</p>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="waste-item-input" placeholder="Es: scatola della pizza, lampadina..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-transparent transition">
                    <button id="ask-gemini-btn" class="gemini-btn bg-blue-500 text-white hover:bg-blue-600 font-semibold py-3 px-5 rounded-lg transition-transform transform hover:scale-105 flex items-center justify-center gap-2">
                        <span>Chiedi ✨</span>
                    </button>
                </div>
                 <button id="recycling-tip-btn" class="gemini-btn mt-4 w-full bg-teal-500 text-white hover:bg-teal-600 font-semibold py-3 px-5 rounded-lg transition-transform transform hover:scale-105 flex items-center justify-center gap-2">
                    <span>Consiglio del giorno ✨</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Gemini Response (Mobile-Friendly) -->
    <div id="gemini-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-md p-6 m-4 text-left transform scale-95 flex flex-col max-h-[85vh]">
            <div class="flex-shrink-0 flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Risposta dell'IA ✨</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="modal-body" class="text-gray-600 space-y-4 overflow-y-auto pr-2">
                <!-- Spinner -->
                <div id="modal-spinner" class="flex justify-center items-center h-32">
                    <div class="spinner w-12 h-12 rounded-full border-4 border-gray-200"></div>
                </div>
                <!-- Content -->
                <p id="modal-text"></p>
            </div>
        </div>
    </div>


    <script>
        // --- DATA AND STATE ---
        const schedule = {
            "2025-04-03": "UO", "2025-04-04": "VR", "2025-04-07": "UO", "2025-04-08": "S", "2025-04-09": "C", "2025-04-10": "UO", "2025-04-11": "P", "2025-04-14": "UO", "2025-04-17": "UO", "2025-04-18": "VR", "2025-04-21": "UO VL", "2025-04-22": "S", "2025-04-23": "C", "2025-04-24": "UO", "2025-04-25": "P", "2025-04-28": "UO",
            "2025-05-01": "UO", "2025-05-02": "VR", "2025-05-05": "UO", "2025-05-06": "S", "2025-05-07": "C", "2025-05-08": "UO", "2025-05-09": "P", "2025-05-12": "UO", "2025-05-15": "UO", "2025-05-16": "VR", "2025-05-19": "UO VL", "2025-05-20": "S", "2025-05-21": "C", "2025-05-22": "UO", "2025-05-23": "P", "2025-05-26": "UO", "2025-05-29": "UO", "2025-05-30": "VR",
            "2025-06-02": "UO", "2025-06-03": "S", "2025-06-04": "C", "2025-06-05": "UO", "2025-06-06": "P", "2025-06-09": "UO", "2025-06-12": "UO", "2025-06-13": "VR", "2025-06-16": "UO VL", "2025-06-17": "S", "2025-06-18": "C", "2025-06-19": "UO", "2025-06-20": "P", "2025-06-23": "UO", "2025-06-26": "UO", "2025-06-27": "VR", "2025-06-30": "UO",
            "2025-07-01": "S", "2025-07-02": "C", "2025-07-03": "UO", "2025-07-04": "P", "2025-07-07": "UO", "2025-07-10": "UO", "2025-07-11": "VR", "2025-07-14": "UO VL", "2025-07-15": "S", "2025-07-16": "C", "2025-07-17": "UO", "2025-07-18": "P", "2025-07-21": "UO", "2025-07-24": "UO", "2025-07-25": "VR", "2025-07-28": "UO", "2025-07-29": "S", "2025-07-30": "C", "2025-07-31": "UO",
            "2025-08-01": "P", "2025-08-04": "UO", "2025-08-07": "UO", "2025-08-08": "VR", "2025-08-11": "UO VL", "2025-08-12": "S", "2025-08-13": "C", "2025-08-14": "UO", "2025-08-15": "P", "2025-08-18": "UO", "2025-08-21": "UO", "2025-08-22": "VR", "2025-08-25": "UO", "2025-08-26": "S", "2025-08-27": "C", "2025-08-28": "UO", "2025-08-29": "P",
            "2025-09-01": "UO", "2025-09-04": "UO", "2025-09-05": "VR", "2025-09-08": "UO VL", "2025-09-09": "S", "2025-09-10": "C", "2025-09-11": "UO", "2025-09-12": "P", "2025-09-15": "UO", "2025-09-18": "UO", "2025-09-19": "VR", "2025-09-22": "UO", "2025-09-23": "S", "2025-09-24": "C", "2025-09-25": "UO", "2025-09-26": "P", "2025-09-29": "UO",
            "2025-10-02": "UO", "2025-10-03": "VR", "2025-10-06": "UO VL", "2025-10-07": "S", "2025-10-08": "C", "2025-10-09": "UO", "2025-10-10": "P", "2025-10-13": "UO", "2025-10-16": "UO", "2025-10-17": "VS", "2025-10-20": "UO", "2025-10-21": "S", "2025-10-22": "C", "2025-10-23": "UO", "2025-10-24": "P", "2025-10-27": "UO", "2025-10-30": "UO", "2025-10-31": "VR",
            "2025-11-03": "UO VL", "2025-11-04": "S", "2025-11-05": "C", "2025-11-06": "UO", "2025-11-07": "P", "2025-11-10": "UO", "2025-11-13": "UO", "2025-11-14": "VR", "2025-11-17": "UO", "2025-11-18": "S", "2025-11-19": "C", "2025-11-20": "UO", "2025-11-21": "P", "2025-11-24": "UO", "2025-11-27": "UO", "2025-11-28": "VR",
            "2025-12-01": "UO VL", "2025-12-02": "S", "2025-12-03": "C", "2025-12-04": "UO", "2025-12-05": "P", "2025-12-08": "UO", "2025-12-11": "UO", "2025-12-12": "VR", "2025-12-15": "UO", "2025-12-16": "S", "2025-12-17": "C", "2025-12-18": "UO", "2025-12-19": "P", "2025-12-22": "UO", "2025-12-28": "UO", "2025-12-29": "VL", "2025-12-30": "S", "2025-12-31": "C",
            "2026-01-02": "P", "2026-01-04": "UO", "2026-01-08": "UO", "2026-01-09": "VR", "2026-01-12": "UO", "2026-01-13": "S", "2026-01-14": "C", "2026-01-15": "UO", "2026-01-16": "P", "2026-01-19": "UO", "2026-01-22": "UO", "2026-01-26": "UO VL", "2026-01-27": "S", "2026-01-28": "C", "2026-01-29": "UO", "2026-01-30": "P",
            "2026-02-02": "UO", "2026-02-05": "UO", "2026-02-06": "VR", "2026-02-09": "UO", "2026-02-10": "S", "2026-02-11": "C", "2026-02-12": "UO", "2026-02-13": "P", "2026-02-16": "UO", "2026-02-19": "UO", "2026-02-23": "UO VL", "2026-02-24": "S", "2026-02-25": "C", "2026-02-26": "UO", "2026-02-27": "P",
            "2026-03-02": "UO", "2026-03-05": "UO", "2026-03-06": "VS", "2026-03-09": "UO", "2026-03-10": "S", "2026-03-11": "C", "2026-03-12": "UO", "2026-03-13": "P", "2026-03-16": "UO", "2026-03-19": "UO", "2026-03-23": "UO VL", "2026-03-24": "S", "2026-03-25": "C", "2026-03-26": "UO", "2026-03-27": "P", "2026-03-30": "UO"
        };
        
        const collectionMap = {
            'UO': 'UO (Frazione Organica)', 'S': 'S (Rifiuto Secco)', 'C': 'C (Carta Cartone Tetrapak)', 'P': 'P (Plastica)', 'VR': 'VR (Verde)', 'VL': 'VL (Vetro Lattine)', 'UO VL': 'UO (Frazione Organica) e VL (Vetro Lattine)', 'VS': 'VS (Raccolta straordinaria del verde)'
        };

        let currentDate = new Date();
        let currentCollectionDescription = "Nessuna raccolta";

        // --- DOM ELEMENTS ---
        const currentDayDisplay = document.getElementById('current-day-display');
        const collectionScheduleEl = document.getElementById('collection-schedule');
        const wasteItemInput = document.getElementById('waste-item-input');
        const modal = document.getElementById('gemini-modal');
        const modalSpinner = document.getElementById('modal-spinner');
        const modalText = document.getElementById('modal-text');

        // --- CALENDAR LOGIC ---
        function updateDisplay() {
            const displayOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const today = new Date(); today.setHours(0,0,0,0);
            const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
            
            let datePrefix = '';
            const normalizedCurrentDate = new Date(currentDate); normalizedCurrentDate.setHours(0,0,0,0);

            if (normalizedCurrentDate.getTime() === today.getTime()) datePrefix = 'Oggi, ';
            else if (normalizedCurrentDate.getTime() === tomorrow.getTime()) datePrefix = 'Domani, ';
            
            let formattedDate = currentDate.toLocaleDateString('it-IT', displayOptions);
            formattedDate = datePrefix + formattedDate.charAt(0).toUpperCase() + formattedDate.slice(1);
            currentDayDisplay.innerText = formattedDate;

            const scheduleKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
            const collectionCode = schedule[scheduleKey];
            
            currentCollectionDescription = "Nessuna raccolta";
            if (collectionCode) {
                currentCollectionDescription = collectionMap[collectionCode] || collectionCode;
            }

            collectionScheduleEl.innerHTML = `È prevista la raccolta di: <br><span class="font-bold text-green-600 text-xl sm:text-2xl mt-2 block">${currentCollectionDescription}</span>`;
        }

        // --- MODAL LOGIC ---
        function showModal() {
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.remove('scale-95');
        }

        function hideModal() {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.add('scale-95');
        }
        
        // --- GEMINI API LOGIC ---
        async function callGemini(prompt) {
            showModal();
            modalText.innerHTML = ""; // Use innerHTML to parse markdown later
            modalSpinner.style.display = 'flex';
            
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                   throw new Error(`API Error: ${response.statusText}`);
                }

                const result = await response.json();
                
                let text = "Non è stato possibile ottenere una risposta. Riprova.";
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    text = result.candidates[0].content.parts[0].text;
                }
                 // A simple markdown to HTML converter
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
                text = text.replace(/\n/g, '<br>'); // Newlines
                modalText.innerHTML = text;
            } catch (error) {
                console.error("Gemini API call failed:", error);
                modalText.innerHTML = "Si è verificato un errore di comunicazione. Controlla la tua connessione e riprova.";
            } finally {
                modalSpinner.style.display = 'none';
            }
        }

        function handleAskGemini() {
            const itemName = wasteItemInput.value.trim();
            if (!itemName) {
                // Using a custom modal for alert
                modalText.innerHTML = "Per favore, inserisci un rifiuto prima di chiedere all'IA.";
                modalSpinner.style.display = 'none';
                showModal();
                return;
            }

            const prompt = `Sei un esperto di raccolta differenziata per i comuni italiani.
            Un utente del comune di Cazzago San Martino (BS), Italia, ha un dubbio su come smaltire questo rifiuto: "${itemName}".
            Oggi, ${currentDate.toLocaleDateString('it-IT', { weekday: 'long' })}, la raccolta prevista è: "${currentCollectionDescription}".
            Le categorie generali di raccolta in questo comune sono: UO (Organico), S (Secco residuo non riciclabile), C (Carta, Cartone, Tetrapak), P (Plastica e imballaggi in plastica), VR (Verde, sfalci e ramaglie), VL (Vetro e Lattine).
            
            Basandoti su queste informazioni, fornisci una risposta chiara, concisa e formattata in Markdown:
            1.  **Conferimento**: Indica in quale contenitore/sacco va gettato il rifiuto.
            2.  **Motivazione**: Spiega brevemente il perché, specialmente se ci sono eccezioni (es. carta unta, ceramica, giocattoli rotti, ecc.).
            3.  **Tempistica**: Se il rifiuto non può essere gettato oggi, indica se deve attendere il prossimo giorno di raccolta corretto o se deve essere portato al centro di raccolta comunale (isola ecologica).
            
            Rispondi in italiano. Sii amichevole ma autorevole.`;

            callGemini(prompt);
        }

        function handleGetRecyclingTip() {
            const prompt = `Sei un esperto di ecologia e buone pratiche di riciclo. Genera un consiglio breve (massimo 2-3 frasi), utile e facile da applicare per migliorare la raccolta differenziata in casa per un cittadino italiano. 
            Rivolgiti all'utente in modo amichevole e incoraggiante.
            Varia i consigli, non dare sempre lo stesso.
            Esempio di output: "Sai che i fazzoletti di carta usati vanno nell'organico e non nella carta? Un piccolo gesto per un grande riciclo!"
            Rispondi in italiano.`;
            
            callGemini(prompt);
        }
        
        // --- EVENT LISTENERS ---
        document.getElementById('next-day').addEventListener('click', () => { currentDate.setDate(currentDate.getDate() + 1); updateDisplay(); });
        document.getElementById('prev-day').addEventListener('click', () => { currentDate.setDate(currentDate.getDate() - 1); updateDisplay(); });
        document.getElementById('go-to-today').addEventListener('click', () => { currentDate = new Date(); updateDisplay(); });
        
        document.getElementById('ask-gemini-btn').addEventListener('click', handleAskGemini);
        wasteItemInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handleAskGemini();
            }
        });

        document.getElementById('recycling-tip-btn').addEventListener('click', handleGetRecyclingTip);

        document.getElementById('close-modal-btn').addEventListener('click', hideModal);
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                hideModal();
            }
        });
        
        // --- INITIALIZATION ---
        window.onload = updateDisplay;
    </script>
</body>
</html>
